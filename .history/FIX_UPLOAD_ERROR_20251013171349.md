# 🔧 Fix: Failed to fetch en Upload

## ❌ Problema

```
TypeError: Failed to fetch
src\app\experiences\[id]\edit\page.tsx (83:26) @ uploadFile
```

**Causa:** La función `uploadFile` en la página de edición usaba una URL de API incorrecta/obsoleta que no coincidía con la detección dinámica implementada en otros archivos.

## ✅ Solución

### Archivos Corregidos:

#### 1. `app/experiences/[id]/edit/page.tsx`

**Antes:**
```typescript
const API_BASE_URL = getApiBaseUrl();
// ...
const response = await fetch(`${API_BASE_URL}/upload/${category}`, {
```

**Después:**
```typescript
const API_BASE_URL = getApiBaseUrl();
// ...
const response = await fetch(`${API_BASE_URL}/api/upload/${category}`, {
```

**Cambios:**
- ✅ Actualizada detección de API URL (ahora usa HTTP en vez de HTTPS)
- ✅ Agregado `/api` en la ruta
- ✅ Agregados logs detallados de upload
- ✅ Mejor manejo de errores

#### 2. `lib/api/experiences.ts`

**Cambios similares:**
- ✅ Agregados logs de upload
- ✅ Mejor manejo de errores en uploads

## 🎯 Nueva Funcionalidad

### Detección Automática de API

La función `uploadFile` ahora detecta automáticamente la URL correcta:

```typescript
// Desktop (localhost)
💻 Upload using localhost API URL: http://localhost:5001

// Mobile (red)
📱 Upload using network API URL: http://192.168.0.2:5001
```

### Logs Mejorados

Ahora verás en consola:

```typescript
📤 Uploading file to: http://localhost:5001/api/upload/images
✅ Upload successful: /uploads/images/file.jpg

// O en caso de error:
❌ Upload failed: 404 Not Found
❌ Upload result failed: {success: false, message: "..."}
```

## 🧪 Cómo Probar

### Test 1: Upload en Desktop

1. Ve a `/experiences`
2. Click "Editar" en una experiencia
3. Intenta subir un archivo (imagen, video o modelo 3D)
4. Abre consola (F12)
5. Debes ver:
   ```
   💻 Upload using localhost API URL: http://localhost:5001
   📤 Uploading file to: http://localhost:5001/api/upload/images
   ✅ Upload successful: /uploads/...
   ```

### Test 2: Upload en Mobile

1. Desde tu teléfono, accede a `http://192.168.0.2:3000`
2. Ve a una experiencia y edítala
3. Intenta subir un archivo
4. Abre consola (F12 en Chrome mobile → Inspect via USB)
5. Debes ver:
   ```
   📱 Upload using network API URL: http://192.168.0.2:5001
   📤 Uploading file to: http://192.168.0.2:5001/api/upload/images
   ✅ Upload successful: /uploads/...
   ```

### Test 3: Crear Nueva Experiencia

1. Ve a `/experiences/new`
2. Completa el formulario
3. Sube un archivo
4. Verifica que funcione sin el error "Failed to fetch"

## 🔍 Verificación de Endpoints

Los uploads ahora usan las rutas correctas del backend:

| Tipo | Ruta |
|------|------|
| Imágenes | `/api/upload/images` |
| Videos | `/api/upload/videos` |
| Modelos 3D | `/api/upload/models` |

**Endpoint base:** Detectado automáticamente según:
- Desktop: `http://localhost:5001`
- Mobile: `http://[TU_IP]:5001`

## ✨ Beneficios

1. **Consistencia**: Misma lógica de detección de API en todos los archivos
2. **Debugging**: Logs claros del proceso de upload
3. **Errores claros**: Mensajes específicos cuando algo falla
4. **Mobile-ready**: Funciona tanto en desktop como en móvil

## 📋 Checklist Post-Fix

- [x] Corregida función uploadFile en edit/page.tsx
- [x] Corregida función uploadFile en lib/api/experiences.ts
- [x] Agregados logs de debugging
- [x] Mejorado manejo de errores
- [x] Verificado que no hay errores de compilación
- [ ] Probar upload en desktop
- [ ] Probar upload en mobile
- [ ] Verificar que los archivos se guardan correctamente

## 🚀 Siguiente Paso

**Recarga la página** y prueba subir un archivo. Ahora debería funcionar correctamente tanto en desktop como en mobile.

Si ves un error, revisa la consola para ver los logs detallados (🔐, ✅, ❌, 📤, 📱, 💻).
