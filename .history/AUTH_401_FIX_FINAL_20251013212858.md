# üîß FIX: Error 401 - LocalStorage Key Mismatch

## ‚ùå Problema Root Cause

El error **401 (Unauthorized)** persist√≠a porque hab√≠a una **inconsistencia en los nombres de las claves de localStorage**:

### AuthService guardaba el token como

```typescript
localStorage.setItem("auth_token", token);  // ‚úÖ Correcto
```

**Ubicaci√≥n**: `src/services/authService.ts` l√≠nea 238

### Pero experiences.ts lo buscaba como

```typescript
localStorage.getItem("token");  // ‚ùå Incorrecto
```

**Ubicaci√≥n**: `src/lib/api/experiences.ts` l√≠nea 57

### Y api.ts tambi√©n lo buscaba incorrectamente

```typescript
localStorage.getItem("token");  // ‚ùå Incorrecto
```

**Ubicaci√≥n**: `src/services/api.ts` l√≠nea 76

## ‚úÖ Soluci√≥n Implementada

### 1. Corregido en `experiences.ts`

```typescript
function getAuthToken(): string | null {
  if (typeof window === "undefined") return null;
  return localStorage.getItem("auth_token"); // ‚úÖ Cambiado de "token" a "auth_token"
}
```

### 2. Corregido en `api.ts`

```typescript
private getAuthToken(): string | null {
  if (typeof window === "undefined") return null;
  return localStorage.getItem("auth_token"); // ‚úÖ Cambiado de "token" a "auth_token"
}
```

## üîç C√≥mo se Descubri√≥ el Problema

1. **Verificaci√≥n del Backend**:
   - Probamos login con PowerShell ‚Üí ‚úÖ Funcion√≥ (200 OK)
   - Probamos `/api/experiences` con token ‚Üí ‚úÖ Funcion√≥ (200 OK)
   - **Conclusi√≥n**: El backend funciona perfectamente

2. **An√°lisis del Frontend**:
   - Revisamos `authService.ts` ‚Üí Guarda como `"auth_token"`
   - Revisamos `experiences.ts` ‚Üí Buscaba como `"token"`
   - **Conclusi√≥n**: ‚ùå **Key mismatch!**

## üß™ Testing Manual con PowerShell

### Login exitoso

```powershell
$body = @{email='jenniffermaldonado1992@gmail.com'; password='123456'} | ConvertTo-Json
$response = Invoke-WebRequest -Uri 'https://localhost:5002/api/v1/auth/login' -Method POST -Body $body -ContentType 'application/json' -SkipCertificateCheck
```

**Resultado**: Token JWT v√°lido generado ‚úÖ

### Experiences con token

```powershell
$token = 'eyJhbGci...' # Token from login
$headers = @{Authorization="Bearer $token"}
$response = Invoke-WebRequest -Uri 'https://localhost:5002/api/experiences' -Headers $headers -SkipCertificateCheck
```

**Resultado**: Status 200 OK ‚úÖ

## üìã Pasos para Verificar la Soluci√≥n

### 1. Limpia el cach√© del navegador

```
F12 ‚Üí Application ‚Üí Storage ‚Üí Clear site data
```

### 2. Recarga la aplicaci√≥n

```
Ctrl + F5 (hard reload)
```

### 3. Haz login

```
Email: jenniffermaldonado1992@gmail.com
Password: 123456
```

### 4. Verifica localStorage en DevTools

```
F12 ‚Üí Console ‚Üí Escribe:
localStorage.getItem('auth_token')
```

**Esperado**: Deber√≠as ver el token JWT completo

### 5. Verifica Network tab

```
F12 ‚Üí Network ‚Üí Click en petici√≥n a /api/experiences
```

**Request Headers debe incluir**:

```
Authorization: Bearer eyJhbGci...
```

### 6. Verifica Response

**Status**: `200 OK` ‚úÖ  
**Body**: JSON con array de experiencias ‚úÖ

## üîë Claves de localStorage Correctas

| Servicio | Clave | Valor |
|----------|-------|-------|
| Auth Token | `auth_token` | JWT string |
| User Data | `auth_user` | JSON object |

## üåê Configuraci√≥n de URLs

### Backend API

- **HTTP**: `http://localhost:5001`
- **HTTPS**: `https://localhost:5002` ‚Üê Usamos este

### Frontend

- **HTTPS**: `https://localhost:3001`
- **Network**: `https://192.168.0.2:3001`

### .env.local

```env
NEXT_PUBLIC_API_BASE_URL=https://localhost:5002
API_INTERNAL_BASE_URL=https://localhost:5002
```

## üìù Archivos Modificados

1. ‚úÖ `qr-ar-admin/src/lib/api/experiences.ts`
   - L√≠nea 57: `localStorage.getItem("auth_token")`

2. ‚úÖ `qr-ar-admin/src/services/api.ts`
   - L√≠nea 76: `localStorage.getItem("auth_token")`

3. ‚úÖ `qr-ar-admin/.env.local`
   - Agregados comentarios explicativos

## ‚ö†Ô∏è Lecciones Aprendidas

1. **Consistencia de nombres**: Usar constantes para claves de localStorage
2. **Debugging systematic**: Verificar backend primero, luego frontend
3. **Testing con PowerShell**: √ötil para aislar problemas de backend vs frontend

## üöÄ Pr√≥ximos Pasos Recomendados

### Mejora: Centralizar constantes

Crear archivo `src/lib/constants.ts`:

```typescript
export const STORAGE_KEYS = {
  AUTH_TOKEN: 'auth_token',
  AUTH_USER: 'auth_user',
} as const;
```

Usar en todos los archivos:

```typescript
import { STORAGE_KEYS } from '@/lib/constants';

localStorage.getItem(STORAGE_KEYS.AUTH_TOKEN);
```

**Beneficio**: Elimina errores de typo y hace el c√≥digo m√°s mantenible.

## üìä Estado Final

- ‚úÖ Backend funcionando en puerto 5002
- ‚úÖ Frontend funcionando en puerto 3001
- ‚úÖ Token JWT guard√°ndose correctamente como `auth_token`
- ‚úÖ Token JWT envi√°ndose en header `Authorization: Bearer ...`
- ‚úÖ Endpoint `/api/experiences` respondiendo 200 OK
- ‚úÖ Login flow completo funcionando

---

**Fecha**: 14 de Octubre 2025 01:30 UTC  
**Issue**: Error 401 persistente en GET /api/experiences  
**Causa Root**: LocalStorage key mismatch (`"token"` vs `"auth_token"`)  
**Status**: ‚úÖ **RESUELTO DEFINITIVAMENTE**
